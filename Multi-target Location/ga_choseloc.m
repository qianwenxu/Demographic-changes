function ga_choseloc

% mainly amended by Chen Zhen, 2012~2016

CityNum=6; %you chan choose 10, 30, 50, 75
city=[69	34	15
3	36	4
-58.4	-34.6	3
149	-35	2
90	23	8
-48	-15.5	9
-75	45	2
121	31.23	1
-74	4	4
15	-4	10
31	30	5
38	9	2
2	49	10
13	52.5	14
77.12	28.36	3
106	-6	18
51	35	15
44	33	5
12	42	4
140	35	13
36	-1	12
126	37	20
101	3	6
-98	19	4
-6	34	5
85	27	2
7	9	11
-76	-12	4
121	15	2
21	52	14
37.35	55.45	7
28	-25	2
-3	40	4
32	15	6
100	13	4
-0.1	51.5	2
-74	40	2
32	0	2
30	50	7
69	41	7
-66	10	4
105	21	2
];
a=[105893.7169	178681.0291	79229.86942	91877.0343	90809.36581	51890.66133	39884.21045	34516.95936	22463.00142	35434.81764	36084.56789	22599.19497	6392.810023	28618.59642	42013.72755	21209.76914	10962.4985	13959.43049	7207.132887	10125.27117	803298.3341
273071.7505	855765.3873	334651.7671	13425128.61	8233831.066	586966.5135	370675.0276	187430.3388	92040.24073	481257.5667	128903.8972	158013.0708	33915.79034	243978.0597	190985.8447	184377.0159	45366.33437	92577.20771	18934.9175	65642.05326	3258620.241
2783667.535	8597242.172	25575782.29	15268042.59	8771477.439	5336662.771	3554841.264	2051454.343	2859110.16	4117089.357	1248327.293	1556962.254	424022.9007	2644203.612	1256877.267	1824226.268	380786.4349	642208.0447	196549.0854	713466.8124	38365659.57
20239998.24	67065194.25	17185710.64	42198848.82	39689015.62	26674226.53	14383327.93	8326162.628	4243162.484	16723944.75	6396460.639	8290563.067	2234391.779	13194270.21	7305785.207	8863363.157	2309122.647	4114495.586	1265387.226	3580645.524	144925536.5
4057514.773	3320032.526	1470309.327	2398878.347	1994386.757	2294591.851	1049322.592	27439067.2	611385.1949	891334.4357	441204.7863	473735.4142	266861.0859	585482.4114	389792.969	456724.2291	197753.3877	1901144.361	272885.3831	250771.5563	24882951.53
2561763.43	5358696.134	2935456.014	7801147.721	5756439.738	3789406.588	2488252.463	957625.1861	222216665.7	2982353.749	828301.7305	1089559.717	2139575.227	2185701.581	870405.7722	1316009.689	241728.6029	416613.0249	164376.7189	579284.0639	24177506.59
20378243.17	50096833.57	15234130.74	32648022.65	31159061.3	19803881.12	12747666.27	7136801.679	3647916.607	16521264.4	5410522.156	6885170.275	1628583.464	11170001.9	8020170.389	7405943.073	2224937.13	2538180.286	1435122.085	3539170.248	141485341.9
1125328230	31174102.14	1195046.776	4393934.431	2480366.948	1716568.147	38920079.05	749469.0633	3330235.571	1183513.085	446323.6828	530726.2222	348091.1072	658348.7101	438014.3124	544666.1018	148836.4602	685903.2765	76354305.89	15002416.2	159579893.4
242312.7516	540274.8681	362529.1616	812103.932	475630.5959	305663.0947	223972.5533	96894.6427	124846.1779	246229.1113	78010.36468	92152.05726	35201.44585	175475.8353	88043.88714	105829.4012	24205.99427	35728.90662	15428.34962	55153.1421	8481231.305
1260579.872	3279665.619	1600128.343	4292787.32	3990327.103	2595501.916	1639376.767	821702.4338	510381.6044	16597132.04	615311.1438	726489.7551	176265.9311	755372.9934	497755.5632	2705440.784	156116.7536	249581.9406	53395.15108	217298.7069	463323037
545009.1116	1863346.515	675960.8549	2103315.897	28878657.6	1860359.334	879219.6373	372182.2134	214814.6895	918357.5225	357902.6629	386461.1407	110822.962	706886.9826	324350.6381	476306.2893	97194.29125	216780.4602	40809.61188	172823.2339	131542307.9
1518837.968	2784691.584	1447041.624	3535905.842	3282343.705	3343469.059	1293522.648	712819.3464	441084.5282	1273530.063	605712.4578	601611.875	152712.4817	622520.2012	437812.3276	625179.9034	162771.1084	236598.2117	84285.2158	192384.04	249197025.3
12183001.05	33206267.51	12010492.61	56752896.14	40868346.55	19500762.48	12982350.37	5818170.447	5316599.175	36283010.39	5137234.783	6099518.114	1623302.968	12415495.63	5958111.401	7330316.651	1713634.498	2705698.628	931135.6991	2771205.593	131308276
53172588.37	214519793.1	75174462.03	180657081.3	183635006.5	122647479.6	84237236.99	41217822.94	18500950.01	86689708.01	29014857.27	39392519.74	7383911.315	100186574.8	41195090.5	55097318.82	14957109.03	26465733.74	6299406.838	24480121.79	1770852654
15627897.21	604968657.4	604565057.3	19703691.73	21935830.14	14877175.76	10812755.13	199085059	4214423.264	4987073.137	1988603.849	53269747.73	894044.9385	5784127.005	4152149.57	2514254.834	74412437.56	2367504.664	544941.5168	1067976.167	80288275.37
9228902.138	11152380.29	938627.1185	10223231.51	1853163.394	1917166.834	951402.8718	545810.1019	693045.3424	819843.6115	834674.1604	443198.2279	425714.6369	563017.3247	462514.0224	449433.358	103091.0869	60083227.82	334791.2968	526970.4023	150838611.3
3473245.331	11310305.86	4361063.917	12290825.73	33081789.09	8132595.642	5053885.219	2304761.063	1233170.636	5254218.787	1803588.573	2383409.697	444285.9041	2772088.602	96407593.04	2726281.146	620923.9058	1030170.491	253098.1253	807742.4582	40674354.3
215890.8452	550955.541	232490.0631	540691.4334	18486444.51	413493.1597	243556.0485	131777.9546	71647.32357	240594.4632	103056.1654	113014.0948	26592.59086	141421.7017	1002638.685	132792.6089	33577.00267	58167.92994	16826.11253	45536.81042	6292866.285
6141878.425	15872503.35	5894176.013	14309985.05	12717948.67	7909587.259	5737218.269	2938927.103	2762718.319	6475098.591	3185894.317	2518277.355	609727.6311	5145142.627	2492350.483	3005675.049	820262.2622	1209823.934	473893.7633	1192565.721	74232354.86
20765818.83	5115643.963	1649374.589	4935908.714	3082604.524	2048852.737	2055866.443	836628.2731	8666382.426	1497922.341	683217.7753	652069.933	44718176.47	898537.6228	721135.6274	620799.018	158066.5125	424801.2242	1007591.395	5599904.888	13176253.97
1689400.553	81927889.92	1818331.088	5813715.893	5389481.915	5550791.081	2220114.386	913551.8046	575579.3242	2038038.6	802893.9276	57270797.17	467249.7895	965967.5411	644010.0111	49410161.85	194470.5672	309558.8656	86837.98035	402728.476	33802883.05
6307106.878	1692934.578	411959.4412	1101462.587	896542.7436	548176.0321	609406.3311	231312.6761	177498.1971	410582.5721	611223.5876	246396.1635	226309.7761	269300.564	351037.3043	248720.4305	50367.22036	176214.5718	412880.4704	6101947.737	7155313.446
2217012.576	5803458.617	2353736.867	3207081.917	2174692.932	4661430.085	1029851.73	2270941.121	927962.4703	998849.6435	1235926.625	673360.0888	256572.0457	719953.5562	624562.8614	585956.0371	297839.3739	6078479.673	122870.62	263672.4372	29966438.89
2359609.014	5450618.569	1851141.857	4880392.33	4163515.359	2711289.763	2025500.436	788756.1001	678039.2053	1919127.851	703061.5485	822058.8992	339775.2825	1384636.849	885913.6674	906105.7855	235785.8533	291677.1632	154551.5255	652882.988	19004732.52
4604125.998	4697065.528	2775364.866	2200191.237	1347340.606	778720.1626	662738.7774	1052874.935	929298.4795	757091.3314	1338198.637	587303.4777	256230.4443	329582.646	518539.8184	400522.9461	355744.5038	357445.1719	308225.4745	214356.7586	15454508.73
628967.2036	6011864.605	5822366.368	379503.8491	403433.5992	262560.4245	210827.1802	1845100.305	67023.66436	130270.1901	65063.53585	587743.1522	19876.32151	108428.1822	77052.9241	65795.45556	816324.1781	39040.31552	40959.12844	31058.59571	10249937.66
2729115.584	6346979.126	2749611.725	7284013.161	6913537.105	4675595.231	2850822.239	1396528.31	886585.551	2989509.125	390918057.2	1387241.985	318100.3163	1453803.073	1006204.716	1521904.443	349657.8967	539428.5438	172982.8211	452512.3848	299681480.7
305712.9752	549720.0499	398561.9053	9528254.616	510122.497	328815.885	236318.1351	151211.1183	221286.4622	270838.3777	85424.47285	98377.18209	75204.82753	191352.7043	87399.79569	113452.6771	24333.46911	38233.00697	19070.50287	60453.32915	6092174.95
1718128.979	1355668.641	468200.2864	1055637.309	886851.7997	583181.7096	452688.7177	218022.4134	160864.8149	422540.7934	160238.146	194393.6981	168817.7916	307555.3305	190289.9067	206270.8672	61516.59065	100474.2127	111911.5346	157525.2926	32083999.9
987559.1844	5372239.914	1266542.8	3865258.625	3678263.665	2471445.246	2216794.791	686433.7017	371555.5724	1911880.836	545425.4259	748711.2158	145126.8557	1773648.901	697156.6696	972254.6635	213170.249	376025.1563	91165.35412	379575.7894	31259814.4
6298471.059	40972205.62	7180599.432	16731496.04	16814543.21	11427506.08	20305362.74	4007302.325	1877986.516	8618360.396	3070862.75	4305520.326	854945.6814	9013424.874	4887624.405	7979732.212	2048213.393	4297153.884	1418878.774	7782843.362	3472946926
2128665.056	9748068.735	2818092.224	7327048.442	7095438.931	4213601.857	2775834.723	1430373.693	695433.9812	3045658.819	1627520.089	1670435.023	272300.9941	2573283.413	1190062.15	1913612.381	437979.9677	667389.8681	183602.2729	594939.4006	48354023.41
7528444.497	19842856.67	9604980.535	32475673.06	18521286.9	11760554.02	8007486.936	3542810	4303869.054	11053727.6	3757003.48	3770254.7	879883.7782	7908706.578	3324919.609	4588105.374	1045400.022	1659485.135	595924.7332	1674942.123	83607830.28
748877.0451	6498376.018	1026703.659	7721474.569	4734351.701	21904963.57	1139597.423	559764.9978	266913.0231	1166525.322	1899735.266	745192.8607	99802.11733	663762.5421	431683.7609	826870.1572	155587.1378	257550.5182	59064.60496	200729.7049	23208452.2
3391099.327	8801857.312	3115929.568	29621388.9	8681647.22	5722194.658	3653346.911	1668960.993	990941.0717	3654423.404	1401685.808	1660554.357	523887.0186	2011180.229	1323267.122	1856437.281	444272.5115	719685.9904	240829.191	870696.1849	50749792.7
1233355.465	185824237.2	1672849.759	6738049.746	5962117.429	11134376.45	1896810.576	857801.4553	462256.9993	1964839.002	970560.3443	3158215.072	176730.533	934120.8417	606043.7569	2954246.716	195992.7322	314618.1104	67559.5789	270856.8199	20501181.84
1687949.894	12793511.06	1905565.911	4558785.503	4539445.375	3078666.958	6227181.808	1040205.206	498125.2866	2236285.246	790052.4909	1085604.23	212019.3688	2066109.993	1140554.781	1785301.484	431650.2856	859044.5246	265787.1627	1345651.828	416410012.7
8486392.18	36400280.17	12556286.91	23156761.19	22113428.13	14557206.07	9003923.9	6179580.68	2797141.549	10480684.96	7073277.091	6813279.828	1172345.525	8712601.234	4969328.308	7045933.337	1793341.285	2218826.089	666801.248	2069905.58	108232855.4
124596124	270168445.4	93718323.96	221329250.6	198940001.9	129312141.8	98647905.77	42026478.74	32058747.79	91431940	38022859.79	41781385.56	16641900.29	68905081.15	47306644.91	45567365.39	12832540.67	15473924.32	8411696.974	32849106.89	926532390.2
1765265.32	5977230.647	1559483.53	2900322.179	2747465.478	1629523.363	2099502.316	729082.7057	434417.72	1088666.144	621721.5884	560789.5305	146819.8018	829009.9414	503324.5113	593756.4665	216023.5896	301778.4038	123775.8031	264597.0373	22076364.25
1375166.81	2918745.635	1460681.801	22186536.78	2608059.494	1707910.555	1139899.176	646701.5985	838960.2994	1542501.425	451198.1422	589287.89	151997.2559	1022239.051	410479.7911	662294.3773	104212.647	164485.4616	95207.40695	221142.2433	41672727.17
93486.40542	266597.7897	83733.18612	216710.9918	174312.5207	109241.1622	76817.96557	54184.06227	73593.48897	70697.05675	108947.8811	45055.11346	14392.92195	55503.32277	50184.16085	47417.25157	10462.77288	34868.32166	6282.407121	19110.75353	4219002.288
42175604.9	138595608.2	59910222.08	76478454.26	82300792.86	50408729.02	37805548.18	28370475.12	9169430.603	33244831.22	15797857.15	16717547.85	2979322.224	28562534.82	15356506.14	17814470.28	8447231.496	13075449.33	3336171.589	8402129.378	1064887972
];
inn=10; %初始种群大小
gnmax=100;  %最大代数
pc=0.8; %交叉概率
pm=0.3; %变异概率

%产生初始种群
s=zeros(inn,CityNum);
for i=1:inn
    s1=1:42;
    K=randperm(length(s1)); 
    s(i,:)=s1(K(1:6));
end
[~,~,~,p]=z1(s,city,a);

gn=1;
ymean=zeros(gn,1);
ymax=zeros(gn,1);
yfz1max=zeros(gn,1);
yfz2min=zeros(gn,1);
xmax=zeros(inn,CityNum);
scnew=zeros(inn,CityNum);
smnew=zeros(inn,CityNum);
while gn<gnmax+1
   for j=1:2:inn
      seln=sel(p);  %选择操作
      scro=cro(s,seln,pc);  %交叉操作
      scnew(j,:)=scro(1,:);
      scnew(j+1,:)=scro(2,:);
      smnew(j,:)=mut(scnew(j,:),pm);  %变异操作
      smnew(j+1,:)=mut(scnew(j+1,:),pm);
   end
   s=smnew;  %产生了新的种群
   [f,fz1,fz2,p]=z1(s,city,a);  %计算新种群的适应度[f,fz1,fz2,p]
   %记录当前代最好和平均的适应度
   [fmax,nmax]=max(f);
   fz1max=fz1(nmax);
   fz2min=fz2(nmax);
   ymean(gn)=mean(f)/30;
   ymax(gn)=fmax;
   yfz1max(gn)=fz1max;
   yfz2min(gn)=fz2min;
   %记录当前代的最佳个体
   x=s(nmax,:);
   xmax(gn,:)=x;
   gn=gn+1;
end
[max_ymax,index]=max(ymax);

figure(1);
plot(ymax,'r'); 
xlim([1,gnmax]);
figure(2);
plot(yfz1max,'b');
xlim([1,gnmax]);
title('population-language');
figure(3);
plot(yfz2min,'k');
hold on;
%ylim([0.8*10^10,1.3*10^10]);
xlim([1,gnmax]);
%hold on;
%plot(ymean,'b');grid;
title('distance');
%legend('最优解','平均解');
fprintf('遗传算法得到的最短距离:%.2f\n',max_ymax);
fprintf('遗传算法得到的最短路线');
disp(xmax(index,:));
end

function fdist=fd(i,j,city)
dist=distance(city(i,1),city(i,2),city(j,1),city(j,2))/180*pi*6370;
if (dist<200)
    fdist=1;
elseif(dist<12907)
    fdist=1/2+1/2*cos((pi/12707)*(dist-6553.5)+pi/2);
else
    fdist=0;
end
end

function [caldist,calz11,calz12]=cald(sii,city,a)
si=[sii 8 37];
caldist=0;
calz11=0;
calz12=0;
%disp('si:');
%disp(si);
atowho=zeros(1,42);
for i=1:42
    max=0;
    maxz11=0;
    minz12=999999;
    who=0;
    for j=1:8
        lang=city(i,3);
        if(lang~=2)
            langnum=a(i,lang)+a(i,2);
        else
            langnum=a(i,lang);
        end
        langnum1=sum(a(i,:))-langnum;
        z11=fd(si(j),i,city)*(langnum+langnum1*0.05);
        dist=distance(city(i,1),city(i,2),city(si(j),1),city(si(j),2))/180*pi*6370;
        z12=(dist/12907)*z11;
        val=z11-z12;
        if(max<val)
            max=val;
            maxz11=z11;
            minz12=z12;
            who=si(j);
        end
    end
    caldist=caldist+max;
    calz11=calz11+maxz11;
    calz12=calz12+minz12;
    atowho(i)=who;
end
%disp(atowho);
%disp('sum:');
%disp(caldist);
end


%------------------------------------------------
%计算所有城市的语言和
function [f,fz1,fz2,p]=z1(s,city,a)

inn=size(s,1);  %读取种群大小
f=zeros(inn,1);
fz1=zeros(inn,1);
fz2=zeros(inn,1);
fi=zeros(inn,1);
for i=1:inn
   [f(i),fz1(i),fz2(i)]=cald(s(i,:),city,a);  %计算函数值，即适应度
   fi(i)=(f(i)-2.5*10^9)/10^8;  
   if(cald(s(i,:),city,a)<2.5*10^9)
       fi(i)=0;
   end
end
f=f'; %取人口值

%根据个体的适应度计算其被选择的概率
fsum=0;
for i=1:inn
   fsum=fsum+fi(i)^15;% 让适应度越好的个体被选择概率越高
end
ps=zeros(inn,1);
for i=1:inn
   ps(i)=fi(i)^15/fsum;
end

%计算累积概率
p=zeros(inn,1);
p(1)=ps(1);
for i=2:inn
   p(i)=p(i-1)+ps(i);
end
p=p';
end



%--------------------------------------------------
%根据变异概率判断是否变异
function pcc=pro(pc)
test(1:100)=0;
l=round(100*pc);
test(1:l)=1;
n=round(rand*99)+1;
pcc=test(n);   
end

%--------------------------------------------------
%“选择”操作
function seln=sel(p)

seln=zeros(2,1);
%从种群中选择两个个体，最好不要两次选择同一个个体
for i=1:2
   r=rand;  %产生一个随机数
   prand=p-r;
   j=1;
   while prand(j)<0
       j=j+1;
   end
   seln(i)=j; %选中个体的序号
   if i==2&&j==seln(i-1)    %%若相同就再选一次
       r=rand;  %产生一个随机数
       prand=p-r;
       j=1;
       while prand(j)<0
           j=j+1;
       end
   end
end
end

%------------------------------------------------
%“交叉”操作
function scro=cro(s,seln,pc)

bn=size(s,2);
pcc=pro(pc);  %根据交叉概率决定是否进行交叉操作，1则是，0则否
scro(1,:)=s(seln(1),:);
scro(2,:)=s(seln(2),:);
if pcc==1
   c1=round(rand*(bn-2))+1;  %在[1,bn-1]范围内随机产生一个交叉位
   c2=round(rand*(bn-2))+1;
   chb1=min(c1,c2);
   chb2=max(c1,c2);
   middle=scro(1,chb1+1:chb2);
   scro(1,chb1+1:chb2)=scro(2,chb1+1:chb2);
   scro(2,chb1+1:chb2)=middle;
   for i=1:chb1 %似乎有问题
       while find(scro(1,chb1+1:chb2)==scro(1,i))
           zhi=find(scro(1,chb1+1:chb2)==scro(1,i));
           y=scro(2,chb1+zhi);
           scro(1,i)=y;
       end
       while find(scro(2,chb1+1:chb2)==scro(2,i))
           zhi=find(scro(2,chb1+1:chb2)==scro(2,i));
           y=scro(1,chb1+zhi);
           scro(2,i)=y;
       end
   end
   for i=chb2+1:bn
       while find(scro(1,1:chb2)==scro(1,i))
           zhi=logical(scro(1,1:chb2)==scro(1,i));
           y=scro(2,zhi);
           scro(1,i)=y;
       end
       while find(scro(2,1:chb2)==scro(2,i))
           zhi=logical(scro(2,1:chb2)==scro(2,i));
           y=scro(1,zhi);
           scro(2,i)=y;
       end
   end
end
end

%--------------------------------------------------
%“变异”操作
function snnew=mut(snew,pm)

bn=size(snew,2);
snnew=snew;

pmm=pro(pm);  %根据变异概率决定是否进行变异操作，1则是，0则否
if pmm==1
   c1=round(rand*(bn-1))+1;  %在[1,bn]范围内随机产生一个变异位
   c2=round(rand*41)+1;
   while(ismember(c2,snew))
       c2=round(rand*41)+1;
   end
   snnew(c1)=c2;
end
end
